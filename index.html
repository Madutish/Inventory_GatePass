<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Inventory Pro</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- PROFESSIONAL THEME VARIABLES --- */
        :root {
            --primary: #1565c0; /* Enterprise Blue */
            --primary-dark: #0d47a1;
            --accent: #ff6f00; /* Amber for actions */
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-light: #546e7a;
            --border: #e0e0e0;
            --success: #2e7d32;
            --danger: #c62828;
            --shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background: var(--bg-body); margin: 0; padding: 0; color: var(--text-main); -webkit-font-smoothing: antialiased; }

        /* STATUS LIGHT */
        .status-indicator { position: fixed; top: 20px; right: 20px; background: white; padding: 8px 16px; border-radius: 50px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px; z-index: 2000; box-shadow: var(--shadow); border: 1px solid var(--border); color: var(--text-light); }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .dot.green { background-color: var(--success); box-shadow: 0 0 4px var(--success); }
        .dot.red { background-color: var(--danger); }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: white; padding: 50px 40px; border-radius: 12px; text-align: center; width: 340px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .login-box h2 { margin: 10px 0 30px 0; color: var(--text-main); font-weight: 700; }
        
        .login-input-group { width: 100%; margin-bottom: 15px; text-align: left; }
        .login-box select, .login-box input { 
            width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; 
            background: #fafafa; box-sizing: border-box; height: 50px; font-family: inherit;
        }
        .login-box select:focus, .login-box input:focus { border-color: var(--primary); background: white; outline: none; }
        .login-box button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; border-radius: 6px; font-size: 16px; margin-top: 10px; transition: 0.2s; height: 50px; }
        .login-box button:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3); }

        /* LAYOUT */
        #app-container { display: none; max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px 30px; border-radius: 12px; box-shadow: var(--shadow); }
        .factory-badge { background: #e3f2fd; color: var(--primary); padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; letter-spacing: 0.5px; }
        .logout-btn { cursor: pointer; color: var(--danger); font-weight: 600; display: flex; align-items: center; gap: 5px; font-size: 14px; transition: 0.2s; }
        .logout-btn:hover { opacity: 0.7; }

        /* TABS */
        .tabs { display: flex; gap: 20px; margin-bottom: 20px; padding: 0 10px; }
        .tab { padding: 12px 20px; cursor: pointer; color: var(--text-light); font-weight: 600; display: flex; align-items: center; gap: 8px; border-radius: 8px; transition: 0.2s; }
        .tab.active { background: white; color: var(--primary); box-shadow: var(--shadow); }
        .tab:hover:not(.active) { background: rgba(255,255,255,0.6); }

        /* CARDS & CONTAINERS */
        .content-section { display: none; animation: fadeIn 0.3s ease; }
        .content-section.active { display: block; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 25px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMS */
        label { display: block; font-size: 12px; font-weight: 700; color: var(--text-light); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="password"], select { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 6px; font-size: 14px; box-sizing: border-box; transition: 0.2s; color: var(--text-main); font-family: inherit; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1); }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }

        /* BUTTONS */
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #1b5e20; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b71c1c; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #ef6c00; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-light); }
        .btn-outline:hover { background: #f5f5f5; border-color: #bbb; }

        /* SEARCH RESULTS */
        .search-container { position: relative; }
        .search-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: none; margin-top: 5px; }
        .search-item { padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .search-item:hover { background: #f5f9ff; }
        .item-main { font-weight: 600; color: var(--primary); }
        .item-sub { font-size: 12px; color: var(--text-light); }
        .loc-tag { background: #fff3e0; color: #ef6c00; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; border: 1px solid #ffe0b2; }

        /* TABLES & CART */
        .table-wrapper { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8f9fa; color: var(--text-light); font-weight: 600; padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
        th:hover { background: #e3f2fd; color: var(--primary); }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        .remove-link { color: var(--danger); font-weight: 600; cursor: pointer; font-size: 12px; text-decoration: none; }
        .remove-link:hover { text-decoration: underline; }

        /* UTILS */
        .section-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .password-wrapper { position: relative; width: 100%; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; z-index: 10; }
        .selected-item-card { background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 20px; margin-top: 20px; display: none; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-light); font-style: italic; }

        /* Custom File Input */
        .file-upload-wrapper { position: relative; display: inline-block; margin-bottom: 15px; }
        .file-upload-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .file-upload-btn { display: inline-block; padding: 10px 20px; border: 1px solid var(--border); border-radius: 6px; background: #fafafa; color: var(--text-light); font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .file-upload-btn:hover { background: #f0f0f0; border-color: #ccc; }
        
        /* STOCK FILTER BOX */
        .stock-filter-box { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #bbdefb; }

        /* FIXED HEIGHT CONTROLS FOR ACTION BAR */
        .control-height {
            height: 48px !important;
            box-sizing: border-box !important;
            margin: 0 !important;
        }
    </style>
</head>
<body>

<div class="status-indicator">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Connecting...</span>
</div>

<div id="login-screen">
    <div class="login-box">
        <span class="material-icons" style="font-size: 60px; color: var(--primary); margin-bottom: 10px;">lock_person</span>
        <h2>Factory Inventory</h2>
        
        <div class="login-input-group">
            <select id="factorySelect">
                <option value="FTY01">FACTORY 01</option>
                <option value="FTY03">FACTORY 03</option>
                <option value="FTY04">FACTORY 04</option>
                <option value="FTY05">FACTORY 05</option>
            </select>
        </div>

        <div class="login-input-group">
            <div class="password-wrapper">
                <input type="password" id="loginPass" placeholder="Enter PIN">
                <span class="material-icons password-toggle" onclick="togglePass('loginPass', this)">visibility</span>
            </div>
        </div>

        <button onclick="login()">LOGIN</button>
        <p id="loginMsg" style="margin-top:15px; font-size:14px; color:#d32f2f;"></p>
    </div>
</div>

<div id="app-container">
    
    <div class="header-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="font-weight:700; font-size:18px; color:var(--text-main);">IMS Pro</div>
            <span class="factory-badge" id="displayFactory"></span>
        </div>
        <div class="logout-btn" onclick="location.reload()">
            <span class="material-icons">logout</span> Logout
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('issue-tab', event)"><span class="material-icons">shopping_cart</span> Issue Items</div>
        <div class="tab" onclick="switchTab('receive-tab', event)"><span class="material-icons">add_box</span> Add Stock</div>
        <div class="tab" onclick="switchTab('report-tab', event)"><span class="material-icons">analytics</span> Reports</div>
        <div class="tab" onclick="switchTab('settings-tab', event)"><span class="material-icons">settings</span> Settings</div>
    </div>

    <div id="issue-tab" class="content-section active">
        <div class="card">
            <div class="section-title"><span class="material-icons">badge</span> Requisition Details</div>
            <div class="grid-4">
                <div><label>MR Number</label><input type="text" id="issueMR" placeholder="e.g. MR-2026-001"></div>
                <div><label>Date of Issue</label><input type="date" id="issueDate"></div>
                <div><label>Employee ID</label><input type="text" id="issueEmp" placeholder="e.g. 10455"></div>
                <div><label>Department</label><input type="text" id="issueDept" placeholder="e.g. Sewing Line 4"></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title"><span class="material-icons">search</span> Find & Add Items</div>
            <div class="search-container">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="searchInput" placeholder="Scan or type Part No, Model, or Location..." onkeyup="liveSearch()" autocomplete="off">
                </div>
                <div id="matchesList" class="search-list"></div>
            </div>

            <div id="selectedItemBox" class="selected-item-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--text-main);" id="resPart"></div>
                        <div style="color: var(--text-light); margin-top: 4px;" id="resDesc"></div>
                        <div style="margin-top: 8px;"><span class="loc-tag" id="resLoc"></span></div>
                    </div>
                    <div style="text-align: right;">
                        <label>Stock</label>
                        <div style="font-size: 24px; font-weight: 800; color: var(--success);" id="resStock"></div>
                    </div>
                </div>
                
                <div style="border-top: 1px solid #bbdefb; margin-top: 15px; padding-top: 15px;">
                    <label style="margin-bottom: 5px;">Issue Quantity</label>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="issueQty" value="1" min="1" class="control-height" style="width: 100px; font-size: 18px; font-weight: bold; text-align: center;">
                            
                            <button class="btn btn-accent control-height" onclick="addToCart()">
                                <span class="material-icons">add_shopping_cart</span> Add
                            </button>
                        </div>
                        
                        <button class="btn btn-outline control-height" style="border:none; background:transparent; color: #777;" onclick="resetSearch()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="cartSection" class="card" style="display:none; border-left: 5px solid var(--accent);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="section-title" style="margin-bottom:0; border:none;"><span class="material-icons" style="color:var(--accent);">list_alt</span> Items to Issue</div>
                <span class="remove-link" onclick="clearCart()">Clear All</span>
            </div>
            
            <div class="table-wrapper">
                <table id="cartTable">
                    <thead><tr><th>Location</th><th>Model</th><th>Part No</th><th>Description</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-success" style="padding: 14px 30px;" onclick="submitIssue()">
                    <span class="material-icons">check_circle</span> Finalize & Issue All
                </button>
            </div>
        </div>
    </div>

    <div id="receive-tab" class="content-section">
        <div class="card">
            <div class="section-title"><span class="material-icons">add_circle_outline</span> Manual Entry</div>
            
            <div class="grid-2">
                <div><label>1. Location / Bin</label><input type="text" id="newLoc" placeholder="e.g. Rack A-12"></div>
                <div><label>2. Model / Machine</label><input type="text" id="newModel" placeholder="e.g. JUKI-9000"></div>
            </div>
            <div class="grid-3">
                <div style="grid-column: span 2;"><label>3. Part Number</label><input type="text" id="newPartNo" placeholder="Scan or Type Part No"></div>
                <div><label>5. Quantity</label><input type="number" id="newQty" value="1" style="font-weight: bold;"></div>
            </div>
            <div style="margin-bottom: 20px;">
                <label>4. Description</label><input type="text" id="newDesc" placeholder="Item Name / Specification">
            </div>
            
            <button class="btn btn-success" style="width: 100%;" onclick="receiveItem()"><span class="material-icons">save</span> Add to Inventory</button>
        </div>

        <div class="card" style="text-align: center; border-style: dashed; background: #fafafa;">
            <div class="section-title" style="justify-content: center; border:none; color: var(--primary);"><span class="material-icons">cloud_upload</span> Bulk Import</div>
            <p style="color: var(--text-light); font-size: 13px; margin-top: -10px; margin-bottom: 20px;">Excel Columns: <b>Location, Model, PartNo, Desc, Qty</b></p>
            
            <div class="file-upload-wrapper">
                <button class="file-upload-btn">Choose File</button>
                <input type="file" id="excelFile" accept=".xlsx" onchange="updateFileName(this)">
            </div>
            <span id="fileNameDisplay" style="margin-left: 10px; color: var(--text-light); font-size: 14px;">No file chosen</span>
            <br><br>
            <button class="btn btn-primary" onclick="importFromExcel()"><span class="material-icons">upload_file</span> Upload Excel</button>
        </div>
    </div>

    <div id="report-tab" class="content-section">
        <div class="card">
            <div class="section-title"><span class="material-icons">date_range</span> Reports</div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" style="flex:1;" onclick="loadTransactionReport()">
                    <span class="material-icons">history</span> History
                </button>
                <button class="btn btn-success" style="flex:1;" onclick="loadCurrentStockReport()">
                    <span class="material-icons">inventory</span> Current Stock
                </button>
            </div>

            <div id="dateFilterBox" style="display:block; background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
                <label>Select Date Range for History:</label>
                <div class="grid-2" style="margin-bottom:0;">
                    <input type="date" id="startDate">
                    <input type="date" id="endDate">
                </div>
            </div>

            <div id="stockFilterBox" style="display:none; background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:20px;">
                <label style="color:var(--primary);">Filter Stock List:</label>
                <div class="grid-2" style="margin-bottom:0; grid-template-columns: 3fr 1fr;">
                    <input type="text" id="stockSearchInput" placeholder="Filter by Brand, Model, Part No..." onkeyup="filterStockReport()">
                    <div style="align-self:center; text-align:right; font-weight:600; color:var(--primary);">
                        <span id="stockCount">0</span> Items
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="reportLoading" style="display:none; text-align:center; padding:20px; color:var(--primary); font-weight:600;">Loading Data...</div>
            
            <div class="table-wrapper">
                <div style="overflow-x:auto;">
                    <table id="reportTable"><thead></thead><tbody></tbody></table>
                </div>
            </div>
            
            <div id="noDataMsg" class="empty-state" style="display:none;">No records found.</div>
            
            <div style="text-align: right; margin-top: 15px;">
                <button class="btn btn-primary" onclick="exportToExcel()"><span class="material-icons">download</span> Download Excel</button>
            </div>
        </div>
    </div>

    <div id="settings-tab" class="content-section">
        <div class="card">
            <div class="section-title"><span class="material-icons">lock</span> Security</div>
            
            <div style="margin-bottom: 20px;">
                <label>Current PIN</label>
                <div class="password-wrapper">
                    <input type="password" id="currentPass" placeholder="Enter current PIN">
                    <span class="material-icons password-toggle" onclick="togglePass('currentPass', this)">visibility</span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label>New PIN (Min 10 chars)</label>
                <div class="password-wrapper">
                    <input type="password" id="newPass" placeholder="Enter new PIN">
                    <span class="material-icons password-toggle" onclick="togglePass('newPass', this)">visibility</span>
                </div>
            </div>
            
            <button class="btn btn-primary" style="margin-top: 15px;" onclick="changePassword()">Save New PIN</button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyDD-j_7VC20v4mNFmfdpEGk0yIErDF8Pv8",
        authDomain: "inventory-system-5356c.firebaseapp.com",
        projectId: "inventory-system-5356c",
        storageBucket: "inventory-system-5356c.firebasestorage.app",
        messagingSenderId: "691647241868",
        appId: "1:691647241868:web:3ac4c43e1a7d11b71ba5a9",
        measurementId: "G-D4VWJD23ND"
    };

    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    let db; 

    // INIT
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        statusDot.className = "dot green";
        statusText.innerText = "Online";
    } catch (e) {
        statusDot.className = "dot red";
        statusText.innerText = "Offline";
    }

    let activeFactory = ""; 
    let inventoryCache = [];
    let activeItem = null;
    let issueCart = []; 
    // Variable to hold data for sorting
    let currentReportData = [];

    function formatDate(timestamp) {
        if (!timestamp) return '-';
        return timestamp.toDate().toLocaleDateString();
    }

    window.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
        document.getElementById('issueDate').value = today; // Set default issue date
    });

    // PASSWORD TOGGLE
    window.togglePass = (id, icon) => {
        const input = document.getElementById(id);
        if (input.type === "password") { input.type = "text"; icon.innerText = "visibility_off"; } 
        else { input.type = "password"; icon.innerText = "visibility"; }
    };

    // --- ENABLE ENTER KEY FOR LOGIN ---
    document.getElementById("loginPass").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            login();
        }
    });

    // LOGIN
    window.login = async () => {
        const factory = document.getElementById('factorySelect').value;
        const pass = document.getElementById('loginPass').value.trim();
        const msg = document.getElementById('loginMsg');
        
        if(!db) return;
        msg.innerText = "Verifying...";
        
        try {
            const credRef = doc(db, "credentials", factory);
            const credSnap = await getDoc(credRef);
            let validPassword = "1234"; 
            if(credSnap.exists()) validPassword = credSnap.data().pin;

            if(pass === validPassword) {
                activeFactory = factory;
                document.getElementById('login-screen').style.display = "none";
                document.getElementById('app-container').style.display = "block";
                document.getElementById('displayFactory').innerText = activeFactory;
                refreshInventoryCache(); 
            } else { msg.innerText = "Incorrect PIN"; }
        } catch(e) { console.error(e); msg.innerText = "Connection Error"; }
    };

    window.changePassword = async () => {
        const currentP = document.getElementById('currentPass').value.trim();
        const newP = document.getElementById('newPass').value.trim();

        if(!currentP || !newP) return alert("Please enter both current and new PINs.");
        if(newP.length < 10) return alert("New PIN must be at least 10 characters.");

        try {
            const credRef = doc(db, "credentials", activeFactory);
            const credSnap = await getDoc(credRef);
            let validPassword = "1234"; // Default if not set
            if(credSnap.exists()) validPassword = credSnap.data().pin;

            if(currentP !== validPassword) {
                return alert("Current PIN is incorrect.");
            }

            await setDoc(credRef, { pin: newP });
            alert("PIN Updated Successfully");
            document.getElementById('currentPass').value = "";
            document.getElementById('newPass').value = "";
        } catch (e) {
            console.error(e);
            alert("Error updating PIN.");
        }
    };

    async function refreshInventoryCache() {
        const q = query(collection(db, "inventory"), where("factory_id", "==", activeFactory));
        const snap = await getDocs(q);
        inventoryCache = [];
        snap.forEach(d => inventoryCache.push({ ...d.data(), docId: d.id }));
    }

    // SEARCH
    window.liveSearch = () => {
        const text = document.getElementById('searchInput').value.trim().toUpperCase();
        const list = document.getElementById('matchesList');
        list.innerHTML = "";
        list.style.display = "none";
        
        if(text.length < 2) return;

        const matches = inventoryCache.filter(i => 
            (i.part_number||"").includes(text) || 
            (i.description||"").toUpperCase().includes(text) ||
            (i.model||"").toUpperCase().includes(text) ||
            (i.location||"").toUpperCase().includes(text)
        );

        list.style.display = "block";
        if(matches.length === 0) list.innerHTML = "<div class='search-item' style='color:#999; cursor:default;'>No matching items</div>";
        else matches.forEach(i => {
            const d = document.createElement('div');
            d.className = 'search-item';
            const loc = i.location || "N/A";
            d.innerHTML = `
                <div>
                    <div class="item-main">${i.part_number} <span class="loc-tag">${loc}</span></div>
                    <div class="item-sub">${i.description} ${i.model ? '| ' + i.model : ''}</div>
                </div>
                <div style="font-weight:bold; color:${i.current_stock < 5 ? 'var(--danger)' : 'var(--success)'}">${i.current_stock}</div>
            `;
            d.onclick = () => selectItem(i);
            list.appendChild(d);
        });
    };

    window.selectItem = (i) => {
        activeItem = i;
        document.getElementById('matchesList').style.display = "none";
        document.getElementById('selectedItemBox').style.display = "block";
        
        document.getElementById('resPart').innerText = `${i.part_number}`;
        document.getElementById('resDesc').innerText = `${i.description} ${i.model ? '| ' + i.model : ''}`;
        document.getElementById('resLoc').innerText = i.location ? `LOC: ${i.location}` : "LOC: N/A";
        document.getElementById('resStock').innerText = i.current_stock;
        document.getElementById('issueQty').max = i.current_stock;
        document.getElementById('issueQty').value = 1;
        document.getElementById('searchInput').value = "";
    };

    window.resetSearch = () => {
        document.getElementById('selectedItemBox').style.display = "none";
        activeItem = null;
    };

    // CART
    window.addToCart = () => {
        if(!activeItem) return;
        const qty = parseInt(document.getElementById('issueQty').value);
        if(qty <= 0 || qty > activeItem.current_stock) return alert("Invalid Quantity or Insufficient Stock");
        if(issueCart.some(x => x.docId === activeItem.docId)) return alert("Item already in cart");

        issueCart.push({ ...activeItem, issueQty: qty });
        renderCart();
        resetSearch();
    };

    function renderCart() {
        const section = document.getElementById('cartSection');
        const tbody = document.querySelector("#cartTable tbody");
        
        if(issueCart.length === 0) { section.style.display = "none"; return; }
        
        section.style.display = "block";
        tbody.innerHTML = "";
        issueCart.forEach((item, index) => {
            tbody.innerHTML += `<tr>
                <td style="color:var(--primary); font-weight:600;">${item.location||'-'}</td>
                <td>${item.model||'-'}</td>
                <td>${item.part_number}</td>
                <td>${item.description}</td>
                <td style="text-align:center; font-weight:bold;">${item.issueQty}</td>
                <td style="text-align:right;"><span class="remove-link" onclick="removeFromCart(${index})">Remove</span></td>
            </tr>`;
        });
    }

    window.removeFromCart = (index) => {
        issueCart.splice(index, 1);
        renderCart();
    };
    
    window.clearCart = () => {
        issueCart = [];
        renderCart();
    };

    // SUBMIT ISSUE
    window.submitIssue = async () => {
        const mr = document.getElementById('issueMR').value.trim();
        const emp = document.getElementById('issueEmp').value.trim();
        const dept = document.getElementById('issueDept').value.trim();
        // Get selected date
        const dateInput = document.getElementById('issueDate').value;
        
        if(!mr || !emp || !dept) return alert("Please fill MR No, Employee ID, and Department.");
        if(issueCart.length === 0) return alert("Cart is empty");
        
        // Use selected date or fallback to now
        let txDate = Timestamp.now();
        if(dateInput) {
             const d = new Date(dateInput);
             d.setHours(12,0,0,0); 
             txDate = Timestamp.fromDate(d);
        }

        if(!confirm(`Confirm issue of ${issueCart.length} items for date: ${dateInput || 'Today'}?`)) return;

        try {
            for (const item of issueCart) {
                const ref = doc(db, "inventory", item.docId);
                const snap = await getDoc(ref);
                if(snap.exists()) {
                    let current = snap.data().current_stock;
                    if(current >= item.issueQty) {
                        await updateDoc(ref, { current_stock: current - item.issueQty });
                        await addDoc(collection(db, "transactions"), {
                            factory_id: activeFactory,
                            part_number: item.part_number,
                            description: item.description,
                            model: item.model || "",
                            location: item.location || "",
                            mr_no: mr, emp: emp, dept: dept,
                            qty_issued: item.issueQty,
                            date: txDate // Use selected date
                        });
                    }
                }
            }
            alert("Items Issued Successfully!");
            clearCart();
            document.getElementById('issueMR').value = "";
            document.getElementById('issueEmp').value = "";
            document.getElementById('issueDept').value = "";
            refreshInventoryCache();
        } catch(e) {
            console.error(e);
            alert("Error processing transaction.");
        }
    };

    // ADD STOCK (MANUAL)
    window.receiveItem = async () => {
        let pNo = document.getElementById('newPartNo').value.trim().toUpperCase();
        const qty = parseInt(document.getElementById('newQty').value);
        if(!pNo) pNo = "GEN-" + Date.now();
        const ref = doc(db, "inventory", `${activeFactory}_${pNo}`);
        const snap = await getDoc(ref);
        
        const data = {
            part_number: pNo, factory_id: activeFactory, 
            location: document.getElementById('newLoc').value,
            model: document.getElementById('newModel').value, 
            description: document.getElementById('newDesc').value, 
            current_stock: qty
        };

        if(snap.exists()) await updateDoc(ref, { current_stock: snap.data().current_stock + qty });
        else {
            if(!data.description) return alert("Description is required");
            await setDoc(ref, data);
        }
        alert("Stock Updated!"); 
        document.getElementById('newPartNo').value = "";
        refreshInventoryCache();
    };

    // EXCEL IMPORT (Prioritizes Location -> Model -> PartNo -> Desc -> Qty)
    window.importFromExcel = () => {
        const file = document.getElementById('excelFile').files[0];
        if(!file) return alert("Select File");
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let count = 0;
            for(let row of raw) {
                let clean = {}; Object.keys(row).forEach(k => clean[k.toLowerCase().replace(/[\s\-_.]/g, "")] = row[k]);
                
                let pNo = String(clean['partno']||clean['pno']||"").trim().toUpperCase();
                let qty = parseInt(clean['qty']||clean['quantity']||0);
                let loc = clean['location'] || clean['loc'] || clean['bin'] || ""; 
                let model = clean['model'] || clean['machine'] || "";
                let desc = clean['desc'] || clean['description'] || "";

                if((pNo || desc) && qty > 0) {
                    if(!pNo) pNo = "GEN-" + Math.random().toString(36).substr(2,9).toUpperCase();
                    const ref = doc(db, "inventory", `${activeFactory}_${pNo}`);
                    const s = await getDoc(ref);
                    
                    if(s.exists()) await updateDoc(ref, { current_stock: s.data().current_stock + qty });
                    else await setDoc(ref, { 
                        part_number: pNo, factory_id: activeFactory, 
                        description: desc, model: model, location: loc,
                        current_stock: qty 
                    });
                    count++;
                }
            }
            alert(`Imported ${count} items successfully.`); 
            refreshInventoryCache();
        };
        reader.readAsArrayBuffer(file);
    };

    // --- REPORT: CURRENT STOCK ---
    window.loadCurrentStockReport = () => {
        // UI TOGGLES
        document.getElementById("dateFilterBox").style.display = "none";
        document.getElementById("stockFilterBox").style.display = "block";
        document.getElementById("noDataMsg").style.display = "none";
        
        const thead = document.querySelector("#reportTable thead");
        thead.innerHTML = `
            <tr>
                <th onclick="sortStock('location')">Location ⬍</th>
                <th onclick="sortStock('model')">Model / Brand ⬍</th>
                <th onclick="sortStock('part_number')">Part No ⬍</th>
                <th onclick="sortStock('description')">Description ⬍</th>
                <th onclick="sortStock('current_stock')">Stock ⬍</th>
            </tr>`;
        
        // Load data locally for filtering
        currentReportData = [...inventoryCache]; 
        renderStockTable(currentReportData);
    };

    window.renderStockTable = (data) => {
        const tb = document.querySelector("#reportTable tbody");
        tb.innerHTML = "";
        
        // Update Count
        document.getElementById("stockCount").innerText = data.length;

        if(data.length === 0) {
            tb.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>No matching items</td></tr>";
            return;
        }

        data.forEach(d => {
            tb.innerHTML += `<tr>
                <td style="color:var(--accent); font-weight:600;">${d.location||'-'}</td>
                <td>${d.model||'-'}</td>
                <td>${d.part_number}</td>
                <td>${d.description}</td>
                <td style="font-weight:bold; color:${d.current_stock < 5 ? 'var(--danger)' : 'var(--success)'}">${d.current_stock}</td>
            </tr>`;
        });
    }

    // --- FILTER FUNCTION ---
    window.filterStockReport = () => {
        const val = document.getElementById("stockSearchInput").value.toUpperCase();
        const filtered = inventoryCache.filter(i => 
            (i.part_number||"").includes(val) || 
            (i.model||"").toUpperCase().includes(val) || 
            (i.description||"").toUpperCase().includes(val) ||
            (i.location||"").toUpperCase().includes(val)
        );
        currentReportData = filtered;
        renderStockTable(filtered);
    }

    // --- SORT FUNCTION ---
    let sortDir = 1;
    window.sortStock = (key) => {
        sortDir = -sortDir; // Toggle asc/desc
        currentReportData.sort((a, b) => {
            let valA = a[key] || "";
            let valB = b[key] || "";
            
            // Number sort for stock
            if(key === 'current_stock') {
                return (a[key] - b[key]) * sortDir;
            }
            // String sort for others
            return valA.toString().localeCompare(valB.toString()) * sortDir;
        });
        renderStockTable(currentReportData);
    }

    // --- REPORT: HISTORY ---
    window.loadTransactionReport = async () => {
        // UI TOGGLES
        document.getElementById("dateFilterBox").style.display = "block";
        document.getElementById("stockFilterBox").style.display = "none";
        
        const sVal = document.getElementById('startDate').value;
        const eVal = document.getElementById('endDate').value;
        const loading = document.getElementById('reportLoading');
        loading.style.display = "block";
        document.querySelector("#reportTable tbody").innerHTML = "";

        const q = query(collection(db, "transactions"), where("factory_id", "==", activeFactory));
        const snap = await getDocs(q);
        const docs = [];
        const start = new Date(sVal); const end = new Date(eVal); end.setHours(23,59,59);

        snap.forEach(d => {
            const data = d.data();
            const date = data.date.toDate();
            if(date >= start && date <= end) docs.push(data);
        });
        docs.sort((a,b) => b.date.seconds - a.date.seconds);

        loading.style.display = "none";
        document.getElementById("noDataMsg").style.display = docs.length ? "none" : "block";

        const tb = document.querySelector("#reportTable tbody");
        const thead = document.querySelector("#reportTable thead");
        thead.innerHTML = "<tr><th>Date</th><th>MR No</th><th>Issued To</th><th>Item</th><th>Qty</th></tr>";
        
        docs.forEach(v => {
            tb.innerHTML += `<tr>
                <td>${formatDate(v.date)}</td>
                <td>${v.mr_no}</td>
                <td>${v.emp}<br><small style="color:#999;">${v.dept}</small></td>
                <td>${v.part_number}<br><small style="color:#666;">${v.description}</small></td>
                <td style="font-weight:bold;">${v.qty_issued}</td>
            </tr>`;
        });
    };

    window.exportToExcel = () => {
        const table = document.getElementById("reportTable");
        XLSX.writeFile(XLSX.utils.table_to_book(table), `Report.xlsx`);
    };

    window.switchTab = (id, e) => {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    };

    window.updateFileName = (input) => {
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        if (input.files && input.files.length > 0) {
            fileNameDisplay.textContent = input.files[0].name;
        } else {
            fileNameDisplay.textContent = 'No file chosen';
        }
    };
</script>
</body>
</html>
